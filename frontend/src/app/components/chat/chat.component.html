<div class="chat-container">
  <div class="search-bar">
    <input
      [(ngModel)]="searchQuery"
      placeholder="Search messages..."
      (keyup.enter)="performSearch()"
      (keyup.escape)="clearSearch()"
      class="search-input"
    />

    <button class="btn btn-primary" (click)="performSearch()">Search</button>

    <button *ngIf="searchActive" class="btn btn-secondary" (click)="clearSearch()">Clear</button>

    <div class="dropdown">
      <button class="btn btn-icon dropdown-toggler" (click)="toggleDropdown()">
        <span class="material-icons">more_vert</span>
      </button>
      <div class="dropdown-menu" [class.show]="showDropdown">
        <button class="dropdown-item" (click)="scrollToTop()">Scroll to Top</button>
        <button class="dropdown-item" (click)="exportMessages()">Export as Text</button>
      </div>
    </div>
  </div>

  <div class="messages-container">
    <div *ngIf="loadingMessages" class="loading-indicator">
      Loading messages...
    </div>
    <div *ngIf="!loadingMessages && messages.length === 0" class="empty-state">
      No messages yet. Start the conversation!
    </div>

    <div *ngIf="searchActive" class="search-results-count">
      Found {{filteredMessages.length}} matching messages
    </div>

    <div *ngFor="let message of (searchActive ? filteredMessages : messages); trackBy: trackByMessage"
         class="message"
         [class.current-user]="message.senderId === senderId">

      <div class="sender-name" *ngIf="message.senderId !== senderId">User {{message.senderId}}</div>
      <div class="message-bubble">
        <div class="message-content"
             *ngIf="!message.isEditable"
             [innerHTML]="highlightMatches(message.content)"></div>

        <div class="edit-container" *ngIf="message.isEditable">
          <textarea [(ngModel)]="editingContent" class="edit-textarea"></textarea>
          <div class="edit-actions">
            <button class="save-btn" (click)="saveEdit(message)">Save</button>
            <button class="cancel-btn" (click)="cancelEdit(message)">Cancel</button>
          </div>
        </div>

        <div class="message-actions" *ngIf="message.senderId === senderId">
          <button class="menu-btn" (click)="toggleMenu(message)">â‹®</button>
          <div class="action-menu" [class.show]="message.showMenu" *ngIf="message.showMenu">
            <button class="menu-option" (click)="editMessage(message)">Edit</button>
            <button class="menu-option delete-option" (click)="deleteMessage(message)">Delete</button>
          </div>
        </div>

        <div class="timestamp-hover">{{message.timestamp | date:'shortTime'}}</div>
      </div>
    </div>
  </div>

  <div class="message-input">
    <button (click)="toggleUser()">Switch User (Current: {{senderId}})</button>
    <input
      [(ngModel)]="newMessage"
      placeholder="Type your message..."
      (keyup.enter)="sendMessage()"
    />
    <button (click)="sendMessage()">Send</button>
  </div>
</div>
